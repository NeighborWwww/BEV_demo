# 性能分析指南

本文档介绍如何量化 `main.py` 的性能消耗。

## 方法一：使用内置性能统计功能（推荐）

### 启用性能统计

在运行 `main.py` 时添加 `--perf` 参数：

```bash
python3 main.py --sample 1 --perf
```

### 功能特性

启用性能统计后，程序会：

1. **实时显示性能信息**：在视频画面左上角显示：
   - 当前FPS（最近30帧的平均值）
   - 已处理帧数
   - 各阶段平均耗时（毫秒）：
     - Read: 读取视频帧的时间
     - BEV: 合成BEV画布的时间
     - Grid: 合成四宫格视图的时间
     - Final: 合成最终帧的时间
     - Total: 总耗时

2. **程序结束时打印详细摘要**：
   - 总帧数和总耗时
   - 平均FPS
   - 各阶段平均耗时（毫秒）
   - 各阶段耗时占比（%）

### 示例输出

程序结束时会输出类似以下内容：

```
==================================================
性能统计摘要
==================================================
总帧数: 1500
总耗时: 50.23 秒
平均FPS: 29.86

各阶段平均耗时 (ms):
  读取帧: 2.15
  合成BEV: 8.32
  合成网格: 5.67
  合成最终帧: 0.45
  总耗时: 33.49

各阶段耗时占比 (%):
  读取帧: 12.8%
  合成BEV: 49.5%
  合成网格: 33.7%
  合成最终帧: 2.7%
==================================================
```

## 方法二：使用 cProfile 进行深度性能分析

### 使用 profile_main.py

运行性能分析脚本：

```bash
python3 profile_main.py
```

注意：这个脚本会运行完整的视频处理流程，可以通过 Ctrl+C 中断。

### 查看分析报告

分析完成后，会生成 `performance_profile.txt` 文件，包含：

- 函数调用次数
- 累计耗时
- 每个函数内部耗时
- 调用关系

### 使用 Python 内置工具

也可以直接使用 Python 的 cProfile：

```bash
python3 -m cProfile -o profile.stats main.py --sample 1
```

然后使用 `pstats` 查看：

```python
import pstats
p = pstats.Stats('profile.stats')
p.sort_stats('cumulative').print_stats(20)  # 显示前20个最耗时的函数
```

## 方法三：使用第三方工具

### memory_profiler（内存分析）

1. 安装：
```bash
pip install memory_profiler
```

2. 在代码中添加 `@profile` 装饰器（需要修改代码）

3. 运行：
```bash
python3 -m memory_profiler main.py --sample 1
```

### line_profiler（逐行分析）

1. 安装：
```bash
pip install line_profiler
```

2. 在关键函数上添加 `@profile` 装饰器

3. 运行：
```bash
kernprof -l -v main.py --sample 1
```

## 性能优化建议

根据性能统计结果，可以针对性地优化：

1. **如果"读取帧"耗时高**：
   - 检查视频文件是否在SSD上
   - 考虑使用更快的视频编码格式
   - 降低视频分辨率

2. **如果"合成BEV"耗时高**：
   - 这是最耗时的操作（透视变换）
   - 考虑使用GPU加速（OpenCV with CUDA）
   - 降低BEV画布分辨率
   - 优化H矩阵计算

3. **如果"合成网格"耗时高**：
   - 减少图像resize操作
   - 缓存resize后的帧（如果内存允许）

4. **如果整体FPS低**：
   - 检查是否有其他进程占用CPU
   - 考虑使用多线程并行处理
   - 降低输出分辨率

## 性能基准参考

在标准桌面环境（Intel/AMD CPU）上的参考性能：

- **320x240 分辨率**：约 30 FPS
- **640x480 分辨率**：约 20-25 FPS
- **1280x720 分辨率**：约 10-15 FPS

实际性能取决于：
- CPU性能
- 视频分辨率
- BEV画布大小
- 是否保存视频

## 注意事项

1. 性能统计会略微增加开销（约1-2%），但影响很小
2. 暂停时不会统计性能数据
3. FPS计算基于最近30帧的平均值，更准确反映当前性能
4. 各阶段耗时不包括显示和等待时间
